<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>Курс валют</title>
    <style>
        body {
            color: #333;
            font-family: sans-serif;
            padding: 20px;
        }
        p {
            margin: 10px 0;
        }
        button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            display: none;
        }
        button:hover {
            background-color: #c82333;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .difference-high {
            color: #dc3545;
            font-weight: bold;
        }
        .difference-normal {
            color: #28a745;
        }
    </style>
    <script src="https://live.zwidgets.com/js-sdk/1.3/ZohoEmbededAppSDK.min.js"></script>
</head>
<body>
<p>Курс НБУ: <span id="nbuRate">Завантаження...</span></p>
<p>Курс в Угоді: <span id="dealRate">-</span></p>
<p>Різниця у відсотках: <span id="difference">-</span></p>
<button id="updateButton" onclick="updateData()">Оновити курс до НБУ</button>

<script>
    const NBU_API = "https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?valcode=USD&json";
    let dealRate = null;
    let nbuRate = null;
    let currentRecordId = null;
    let currentDealData = null;

    function calculateDifference(dealRate, nbuRate) {
        if (dealRate && nbuRate && !isNaN(dealRate) && !isNaN(nbuRate)) {
            const diff = ((dealRate / nbuRate - 1) * 100);
            const diffElement = document.getElementById("difference");
            const updateButton = document.getElementById("updateButton");
            
            diffElement.textContent = diff.toFixed(2) + " %";
            
            // Если разница ≥ 5%, показать кнопку и выделить красным
            if (Math.abs(diff) >= 5) {
                updateButton.style.display = "block";
                diffElement.className = "difference-high";
            } else {
                updateButton.style.display = "none";
                diffElement.className = "difference-normal";
            }
        }
    }

    function updateData(){
        if (!nbuRate) {
            alert("Курс НБУ ще не завантажено");
            return;
        }

        if (!currentRecordId) {
            alert("ID записи не визначено");
            return;
        }

        const updateButton = document.getElementById("updateButton");
        updateButton.disabled = true;
        updateButton.textContent = "Оновлення...";

        ZOHO.CRM.API.updateRecord({
            Entity: "Deals",
            RecordID: currentRecordId,
            APIData: {
                ...currentDealData,
                Currency_Rate: nbuRate
            }
        }).then(response => {
            console.log("Успешно обновлено:", response);
            
            // Обновляем отображаемые данные
            dealRate = nbuRate;
            document.getElementById("dealRate").textContent = nbuRate.toFixed(2);
            calculateDifference(dealRate, nbuRate);
            
            alert("Курс успішно оновлено!");
            
            // Обновляем страницу CRM
            ZOHO.CRM.UI.Record.refresh();

        }).catch(err => {
            console.error("Полная ошибка:", err);
            console.error("err.data:", err.data);
            
            if (err.data && err.data[0]) {
                console.error("Детали ошибки:", err.data[0]);
                console.error("Код ошибки:", err.data[0].code);
                console.error("Сообщение:", err.data[0].message);
                console.error("Детали:", err.data[0].details);
                
                alert("Помилка: " + err.data[0].message + " (Код: " + err.data[0].code + ")");
            } else {
                alert("Помилка оновлення курсу");
            }
        }).finally(() => {
            updateButton.disabled = false;
            updateButton.textContent = "Оновити курс до НБУ";
        });
    }

    function loadDealData(recordId) {
        console.log("Загрузка данных для записи:", recordId);
        
        if (!recordId) {
            console.log("ID записи не определен, пробуем без него");
            document.getElementById("dealRate").textContent = "ID запису не визначено";
            return;
        }
        
        ZOHO.CRM.API.getRecord({
            Entity: "Deals",
            RecordID: recordId
        }).then(response => {
            console.log("Ответ API getRecord:", response);
            
            if (response && response.data && response.data.length > 0) {
                const deal = response.data[0];
                currentDealData = deal; // Сохраняем все данные сделки
                currentRecordId = recordId; // Убеждаемся что ID сохранен

                console.log("Данные сделки:", deal);
                console.log("Currency_Rate из сделки:", deal['Currency_Rate']);

                if (deal['Currency_Rate'] !== undefined && deal['Currency_Rate'] !== null) {
                    dealRate = parseFloat(deal['Currency_Rate']);
                } else {
                    dealRate = null;
                }

                if (dealRate && !isNaN(dealRate)) {
                    document.getElementById("dealRate").textContent = dealRate.toFixed(2);
                    
                    // Если курс НБУ уже загружен, пересчитываем разницу
                    if (nbuRate) {
                        calculateDifference(dealRate, nbuRate);
                    }
                } else {
                    document.getElementById("dealRate").textContent = "Поле не знайдено або порожнє";
                    document.getElementById("difference").textContent = "-";
                    document.getElementById("updateButton").style.display = "none";
                }
            } else {
                console.error("Нет данных в ответе:", response);
                document.getElementById("dealRate").textContent = "Немає даних";
            }
        }).catch(err => {
            document.getElementById("dealRate").textContent = "Помилка завантаження";
            document.getElementById("difference").textContent = "-";
            document.getElementById("updateButton").style.display = "none";
            console.error("Ошибка загрузки данных сделки:", err);
        });
    }

    // Инициализация
    ZOHO.embeddedApp.init().then(() => {
        console.log("SDK инициализирован");
        
        // Проверяем доступные методы в SDK
        console.log("Доступные методы ZOHO.CRM:", Object.keys(ZOHO.CRM));
        if (ZOHO.CRM.UI) {
            console.log("Доступные методы ZOHO.CRM.UI:", Object.keys(ZOHO.CRM.UI));
        }

        // Пробуем получить ID текущей записи через событие
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("PageLoad event data:", data);
            if (data && data.EntityId) {
                currentRecordId = data.EntityId;
                console.log("ID получен из PageLoad:", currentRecordId);
                loadDealData(currentRecordId);
            }
        });

        // Альтернативный способ - через API без указания конкретного ID
        // Получаем данные текущей записи напрямую
        setTimeout(() => {
            if (!currentRecordId) {
                console.log("Пробуем получить данные текущей записи без ID...");
                tryGetCurrentRecord();
            }
        }, 1000);

        function tryGetCurrentRecord() {
            // Пробуем получить информацию о текущей странице
            try {
                ZOHO.CRM.API.getAllRecords({
                    Entity: "Deals",
                    per_page: 1
                }).then(response => {
                    console.log("Ответ getAllRecords:", response);
                    // Это не то что нам нужно, но поможет понять структуру
                }).catch(err => {
                    console.log("getAllRecords failed:", err);
                });
            } catch (e) {
                console.log("getAllRecords method not available:", e);
            }

            // Пробуем другие способы
            if (typeof ZOHO.CRM.CONFIG !== 'undefined') {
                ZOHO.CRM.CONFIG.getCurrentUser().then(user => {
                    console.log("Current user:", user);
                }).catch(err => {
                    console.log("getCurrentUser failed:", err);
                });
            }
            
            // Если ничего не работает, показываем ошибку
            setTimeout(() => {
                if (!currentRecordId) {
                    document.getElementById("dealRate").textContent = "Не вдалось отримати ID запису";
                    console.error("Не удалось получить ID текущей записи");
                }
            }, 2000);
        }

        // Получаем курс НБУ
        fetch(NBU_API)
            .then(res => res.json())
            .then(data => {
                nbuRate = data[0].rate;
                document.getElementById("nbuRate").textContent = nbuRate.toFixed(2);
                console.log("Курс НБУ загружен:", nbuRate);
                
                // Если данные сделки уже загружены, пересчитываем разницу
                if (dealRate) {
                    calculateDifference(dealRate, nbuRate);
                }
            })
            .catch(err => {
                document.getElementById("nbuRate").textContent = "Помилка";
                console.error("Ошибка загрузки курса НБУ:", err);
            });

    }).catch(err => {
        document.getElementById("dealRate").textContent = "Помилка SDK";
        console.error("Ошибка инициализации SDK:", err);
    });
</script>
</body>
</html>
