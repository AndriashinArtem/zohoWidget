<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>Курс валют</title>
    <style>
        body {
            color: red;
            font-family: sans-serif;
            padding: 20px;
        }
        p {
            margin: 10px 0;
        }
    </style>
    <script src="https://live.zwidgets.com/js-sdk/1.3/ZohoEmbededAppSDK.min.js"></script>
</head>
<body>
<p>Курс НБУ: <span id="nbuRate">Завантаження...</span></p>
<p>Курс в Угоді: <span id="dealRate">-</span></p>
<p>Різниця у відсотках: <span id="difference">-</span></p>

<script>
    const NBU_API = "https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?valcode=USD&json";
    let nbuRate = null;

    // Получаем курс НБУ один раз при загрузке
    fetch(NBU_API)
        .then(res => res.json())
        .then(data => {
            nbuRate = data[0].rate;
            document.getElementById("nbuRate").textContent = nbuRate.toFixed(4);
        })
        .catch(err => {
            document.getElementById("nbuRate").textContent = "Помилка";
            console.error("Помилка при отриманні курсу НБУ:", err);
        });

    // Ждём инициализации SDK и события PageLoad, чтобы получить текущий recordId из Zoho CRM
    ZOHO.embeddedApp.init()
        .then(() => {
            // Подписываемся на событие загрузки страницы (текущей записи)
            ZOHO.embeddedApp.on("PageLoad", function(data) {
                console.log("PageLoad data:", data);

                const recordId = data.EntityId;
                if (!recordId) {
                    console.warn("RecordId не передан в PageLoad");
                    return;
                }

                // Получаем данные по записи Deals с полученным recordId
                ZOHO.CRM.API.getRecord({
                    Entity: "Deals",
                    RecordID: recordId
                }).then(response => {
                    console.log("Данные сделки:", response);
                    if (response.data && response.data.length > 0) {
                        const deal = response.data[0];
                        const dealRate = deal.Currency_Rate || 0;
                        document.getElementById("dealRate").textContent = dealRate;

                        if (nbuRate) {
                            const diff = ((dealRate - nbuRate) / nbuRate) * 100;
                            document.getElementById("difference").textContent = diff.toFixed(2) + " %";
                        } else {
                            document.getElementById("difference").textContent = "Курс НБУ не завантажено";
                        }
                    } else {
                        document.getElementById("dealRate").textContent = "-";
                        document.getElementById("difference").textContent = "-";
                    }
                }).catch(err => {
                    console.error("Ошибка получения сделки:", err);
                });
            });
        })
        .catch(err => {
            console.error("Ошибка инициализации ZOHO SDK:", err);
        });
</script>
</body>
</html>
