<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>Курс валют</title>
    <style>
        body {
            color: blue;
            font-family: sans-serif;
            padding: 20px;
        }
        p {
            margin: 10px 0;
        }
    </style>
</head>
<body>
<p>Курс НБУ: <span id="nbuRate">Завантаження...</span></p>
<p>Курс в Угоді: <span id="dealRate">-</span></p>
<p>Різниця у відсотках: <span id="difference">-</span></p>

<!-- Zoho SDK -->
<script src="https://js.zohostatic.com/creator/widgets/js/sdk.js"></script>

<script>
    const NBU_API = "https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?valcode=USD&json";
    let nbuRate = null;

    // Получаем курс НБУ
    fetch(NBU_API)
        .then(res => res.json())
        .then(data => {
            nbuRate = data[0].rate;
            document.getElementById("nbuRate").textContent = nbuRate.toFixed(4);
        })
        .catch(err => {
            document.getElementById("nbuRate").textContent = "Помилка";
            console.error("Помилка при отриманні курсу НБУ:", err);
        });

    function getDealData(recordId) {
        if (!recordId) {
            console.warn("Record ID не передан");
            return;
        }

        ZOHO.CRM.API.getRecord({
            Entity: "Deals",
            approved: "both",
            RecordID: recordId
        }).then(response => {
            console.log("Данные записи:", response);
            if (response.data && response.data.length > 0) {
                const deal = response.data[0];
                const dealRate = deal.Currency_Rate || 0;
                document.getElementById("dealRate").textContent = dealRate;

                if (nbuRate) {
                    const diff = ((dealRate - nbuRate) / nbuRate) * 100;
                    document.getElementById("difference").textContent = diff.toFixed(2) + " %";
                } else {
                    document.getElementById("difference").textContent = "Курс НБУ не завантажено";
                }
            } else {
                document.getElementById("dealRate").textContent = "-";
                document.getElementById("difference").textContent = "-";
            }
        });
    }

    function run() {
        ZOHO.embeddedApp.init().then(() => {
            console.log("ZOHO SDK завантажено");
            const recordId = "862445000000518273";
            getDealData(recordId);
        });
    }

    // Функция для ожидания загрузки ZOHO SDK
    function waitForZOHO(callback) {
        if (typeof ZOHO !== "undefined") {
            callback();
        } else {
            console.warn("ZOHO SDK ще не завантажено, повторна спроба через 100 мс...");
            setTimeout(() => waitForZOHO(callback), 100);
        }
    }

    window.addEventListener("DOMContentLoaded", () => {
        waitForZOHO(run);
    });
</script>
</body>
</html>
