<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <title>Курс валют</title>
    <style>
        body {
            color: red;
            font-family: sans-serif;
            padding: 20px;
        }
        p {
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
    </style>
    <script src="https://live.zwidgets.com/js-sdk/1.3/ZohoEmbededAppSDK.min.js"></script>
</head>
<body>
<p>Курс НБУ: <span id="nbuRate">Завантаження...</span></p>
<p>Курс в Угоді: <span id="dealRate">-</span></p>
<p>Різниця у відсотках: <span id="difference">-</span></p>
<button id="updateButton" onclick="updateData()">Оновити курс в угоді</button>

<script>
    const NBU_API = "https://bank.gov.ua/NBUStatService/v1/statdirectory/exchange?valcode=USD&json";
    let nbuRate = null;

    function calculateDifference(dealRate, nbuRate) {
        if (dealRate && nbuRate && !isNaN(dealRate) && !isNaN(nbuRate)) {
            const diff = ((dealRate - nbuRate) / nbuRate) * 100;
            document.getElementById("difference").textContent = diff.toFixed(2) + " %";
        }
    }

    // Глобальная функция для обновления данных
    function updateData() {
        if (!nbuRate) {
            alert("Курс НБУ ещё не загружен");
            return;
        }

        const button = document.getElementById("updateButton");
        button.disabled = true;
        button.textContent = "Оновлення...";

        ZOHO.CRM.API.updateRecord({
            Entity: "Deals",
            APIData: {
                'Currency_Rate': nbuRate
            }
        }).then(response => {
            console.log("Обновлено:", response);
            // Обновляем интерфейс
            document.getElementById("dealRate").textContent = nbuRate.toFixed(4);
            calculateDifference(nbuRate, nbuRate);
            
            button.disabled = false;
            button.textContent = "Оновити курс в угоді";
            alert("Курс успішно оновлено!");
        }).catch(err => {
            console.error("Ошибка обновления:", err);
            button.disabled = false;
            button.textContent = "Оновити курс в угоді";
            alert("Помилка при оновленні курсу");
        });
    }

    // Инициализация
    ZOHO.embeddedApp.init().then(() => {
        // Получаем курс НБУ
        fetch(NBU_API)
            .then(res => res.json())
            .then(data => {
                nbuRate = data[0].rate;
                document.getElementById("nbuRate").textContent = nbuRate.toFixed(4);
                
                // Пересчитываем разницу если курс угоды уже загружен
                const dealRateText = document.getElementById("dealRate").textContent;
                if (dealRateText !== "-" && dealRateText !== "Поле не знайдено" && dealRateText !== "Помилка") {
                    const dealRate = parseFloat(dealRateText);
                    calculateDifference(dealRate, nbuRate);
                }
            })
            .catch(err => {
                document.getElementById("nbuRate").textContent = "Помилка";
                console.error("Ошибка загрузки курса НБУ:", err);
            });

        // Получаем данные сделки
        ZOHO.CRM.API.getRecord({
            Entity: "Deals"
        }).then(response => {
            if (response && response.data && response.data.length > 0) {
                const deal = response.data[0];

                // Ищем поле с курсом
                let dealRate = null;

                if (deal['Currency_Rate'] !== undefined && deal['Currency_Rate'] !== null) {
                    dealRate = parseFloat(deal['Currency_Rate']);
                }

                if (dealRate && !isNaN(dealRate)) {
                    document.getElementById("dealRate").textContent = dealRate.toFixed(4);
                    calculateDifference(dealRate, nbuRate);
                } else {
                    document.getElementById("dealRate").textContent = "Поле не знайдено";
                }
            }
        }).catch(err => {
            document.getElementById("dealRate").textContent = "Помилка";
            console.error("Ошибка загрузки данных угоды:", err);
        });

    }).catch(err => {
        document.getElementById("dealRate").textContent = "Помилка SDK";
        console.error("Ошибка инициализации SDK:", err);
    });
</script>
</body>
</html>
